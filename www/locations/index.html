{% extends "site.html" %}
{% block title %}Locations{% endblock %}

{% block style %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-search/dist/leaflet-search.min.css" />
    <style>
        #map { height: 100vh;}
        .leaflet-control-search {
            width: 250px;
            font-size: 16px;
            margin-bottom: 10px;
          
        }
        .leaflet-control-search input {
            width: 75%;
            padding: 4px 6px;
            font-size: 16px;
        }
    </style>
{% endblock %}

{% block headjs %}
    {{ super() }}
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-search/dist/leaflet-search.min.js"></script>
{% endblock %}

{% block content %}
    <h1>PyLadies Locations</h1>
    <h2>PyLadies Locations</h2>

    <div id="map-container" style="display: flex; height: 100vh;" class="leaflet-container leaflet-retina leaflet-fade-anim">
        <div id="map" style="flex: 4;"></div>
        <div id="chapter" style="flex: 1; padding: 10px; border: 1px solid #ccc; display:none; background: white;">
            <h2 id="chapter-name"></h2>
            <p id="chapter-image"></p>
            <p id="chapter-website"></p>
            <p id="chapter-email"></p>
            <p id="chapter-facebook"></p>
            <p id="chapter-github"></p>
            <p id="chapter-twitter"></p>
            <p id="chapter-meetup"></p>
            <p id="chapter-linkedin"></p>
            <p id="chapter-linkedin"></p>
            <p id="chapter-instagram"></p>
            <button id="close-btn">Close</button>
        </div>
    </div>


    <section id="archive">
            <article class="chapters">
                <div class="social">

                    {% for chapter in site.chapters %}
                    <div class="chapter_location" data-meetup-id="{{chapter.meetup_id}}" data-chapter-name="{{ chapter.name }}" >
                        <div class="logo-container">
                          {% if chapter.image %}
                            <img src="../assets/images/{{chapter.image}}" alt="{{chapter.name}}" />
                          {% else %}
                            <img src="../assets/images/pyladies-sq-logo.png" alt="{{chapter.name}}" />
                          {% endif %}
                        </div>
                        <h3 class="chpts chapter-name">
                            {% if chapter.external_website %}
                                <a href="{{chapter.website}}">
                            {% else %}
                                <a href="/locations/{{chapter.website}}">
                            {% endif %}
                            {{chapter.name}}</a>
                        </h3>
                        <h3 class="chpts social-icons">
                            {% if chapter.website %}
                            <a class="icon-earth" data-icon="&#xe9ca;" href="{{chapter.website}}" title="Website"></a>
                            {% endif %}
                            {% if chapter.email %}
                            <a class="icon-mail4" data-icon="&#xea86;" href="mailto:{{chapter.email}}" title="Contact"></a>
                            {% endif %}
                            {% if chapter.facebook %}
                            <a class="icon-facebook" data-icon="&#xea90;" href="https://facebook.com/{{chapter.facebook}}" title="Facebook"></a>
                            {% endif %}
                            {% if chapter.github %}
                            <a class="icon-github" data-icon="&#xeab0;" href="https://github.com/{{chapter.github}}" title="GitHub"></a>
                            {% endif %}
                            {% if chapter.twitter %}
                            <a class="icon-twitter" data-icon="&#xea96;" href="https://twitter.com/{{chapter.twitter}}" title="Twitter"></a>
                            {% endif %}
                            {% if chapter.meetup %}
                            <a class="icon-meetup" data-icon="&#xe901;" title="Meetup Link" href="https://www.meetup.com/{{chapter.meetup}}/"></a>
                            {% endif %}
                            {% if chapter.linkedin %}
                            <a class="icon-linkedin2" data-icon="&#xeaca;" title="LinkedIn Link" href="https://www.linkedin.com/{{chapter.linkedin}}/"></a>
                            {% endif %}
                            {% if chapter.instagram %}
                            <a class="icon-instagram" data-icon="&#xea92;" title="Instagram Link" href="https://www.instagram.com/{{chapter.instagram}}/"></a>
                            {% endif %}
                        </h3>
                    </div>
                    {% endfor %}
              </div>
            </article>
    </section>

    <script>
        // Initialize map
        const map = L.map("map").setView([30, 0], 2);

        // Add OpenStreetMap tiles
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "&copy; OpenStreetMap contributors"
        }).addTo(map);

        // Chapters
        const chapters = {{ site.chapters | tojson }};

        // Feature group for markers
        const markers = L.featureGroup().addTo(map);

        // Chapter panel elements
        const chapterPanel = document.getElementById('chapter');
        const chapterName = document.getElementById('chapter-name');
        const chapterImage = document.getElementById('chapter-image');
        const chapterWebsite = document.getElementById('chapter-website');
        const chapterEmail = document.getElementById('chapter-email');
        const chapterFacebook = document.getElementById('chapter-facebook');
        const chapterGithub = document.getElementById('chapter-github');
        const chapterTwitter = document.getElementById('chapter-twitter');
        const chapterMeetup = document.getElementById('chapter-meetup');
        const chapterLinkedin = document.getElementById('chapter-linkedin');
        const chapterInstagram = document.getElementById('chapter-instagram');


        const closeBtn = document.getElementById('close-btn');

        // Create markers
        chapters.forEach(p => {
          if (
              p.location &&
              p.location.latitude && 
              p.location.longitude
          ){
              const customIcon = L.icon({
                iconUrl: `https://pyladies.com/assets/images/${p.image}`,
                iconSize: [20, 20],
                iconAnchor: [16, 20],
                popupAnchor: [0, -20]
              });
              const marker = L.marker([p.location.latitude, p.location.longitude], {
                icon: customIcon,
                name: p.name
              }).addTo(markers);

              // On click, update chapter panel
              marker.on('click', () => {
                chapterName.textContent = p.name;
                chapterImage.innerHTML = p.image ? `<img style="max-height: 100px; max-width:100px; vertical-align: middle;" src="https://pyladies.com/assets/images/${p.image}"/>` : '';
                chapterWebsite.innerHTML = p.website ? `<i style="color: grey">Website</i><br><a target = "_blank" href="${p.website}">${p.website}</a>` : '';
                chapterEmail.innerHTML = p.email ? `<i style="color: grey">Email</i><br><a target = "_blank" href="mailto:${p.email}">${p.email}</a>` : '';
                chapterFacebook.innerHTML = p.facebook ? `<i style="color: grey">Facebook</i><br><a target = "_blank" href="https://facebook.com/${p.facebook}">${p.facebook}</a>` : '';
                chapterGithub.innerHTML = p.github ? `<i style="color: grey">Github</i><br><a target = "_blank" href="https://github.com/${p.github}">${p.github}</a>` : '';
                chapterTwitter.innerHTML = p.twitter ? `<i style="color: grey">Twitter</i><br><a target = "_blank" href="https://twitter.com/${p.twitter}">${p.twitter}</a>` : '';
                chapterMeetup.innerHTML = p.meetup ? `<i style="color: grey">Meetup</i><br><a target = "_blank" href="https://www.meetup.com/${p.meetup}">${p.meetup}</a>` : '';
                chapterLinkedin.innerHTML = p.linkedin ? `<i style="color: grey">LinkedIn</i><br><a target = "_blank" href="https://www.linkedin.com/${p.linkedin}">${p.linkedin}</a>` : '';
                chapterInstagram.innerHTML = p.instagram ? `<i style="color: grey">Instagram</i><br><a target = "_blank" href="https://www.instagram.com/${p.instagram}">${p.instagram}</a>` : '';
                chapterPanel.style.display = 'block';
              });
            }
        });

        // Add search control
        const searchControl = new L.Control.Search({
          layer: markers,
          propertyName: 'name',
          marker: false,
          moveToLocation: function(latlng, name, map) {
            map.setView(latlng, 16); // zoom to marker
          },
          autoCollapse: false,
          collapsed: false,
          position: 'topleft',
          filterData: function(text, records) {
            const results = {};
            for (let id in records) {
              const record = records[id];
              // split name by spaces, commas, etc., then match
              const words = record.layer.options.name.toLowerCase().split(/[\s,]+/);
              if (words.some(w => w.includes(text.toLowerCase()))) {
                results[id] = record;
              }
            }
            return results;
          }
        });

        // Trigger marker click on search result to update chapter panel
        searchControl.on('search:locationfound', function(e) {
          e.layer.fire('click');
        });
        map.addControl(searchControl);


        map.removeControl(map.zoomControl);
        L.control.zoom({ position: 'bottomleft' }).addTo(map);

        // Close button
        closeBtn.addEventListener('click', () => {
          chapterPanel.style.display = 'none';
        });

    </script>

{% endblock %}
